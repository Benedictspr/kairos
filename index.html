<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>KAIROS | Benedict</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-deep: #030303;
        --glass-panel: rgba(18, 18, 18, 0.75);
        --glass-mobile: rgba(10, 10, 10, 0.9);
        --glass-border: rgba(255, 255, 255, 0.08);
        --glass-highlight: rgba(255, 255, 255, 0.04);
        
        --text-main: #f2f2f2;
        --text-muted: #858585;
        --accent: #ffffff;
        
        --radius-lg: 24px;
        --radius-md: 16px;
        --radius-sm: 12px;
        
        --font: 'Plus Jakarta Sans', -apple-system, sans-serif;
        --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
        
        /* Mobile Safe Areas */
        --safe-top: env(safe-area-inset-top);
        --safe-bottom: env(safe-area-inset-bottom);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }

    body {
        background-color: var(--bg-deep);
        /* Subtle, premium gradient */
        background-image: 
            radial-gradient(circle at 0% 0%, rgba(50, 50, 50, 0.3), transparent 40%),
            radial-gradient(circle at 100% 100%, rgba(30, 30, 30, 0.2), transparent 40%);
        color: var(--text-main);
        font-family: var(--font);
        display: flex;
        height: 100vh;
        height: 100dvh;
        overflow: hidden;
        padding: 16px;
        gap: 16px;
        font-size: 14px;
        -webkit-font-smoothing: antialiased;
    }

    /* --- SIDEBAR --- */
    #sidebar {
        width: 280px;
        background: var(--glass-panel);
        backdrop-filter: blur(40px);
        -webkit-backdrop-filter: blur(40px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        display: flex;
        flex-direction: column;
        padding: 24px;
        z-index: 50;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        transition: transform 0.5s var(--ease);
    }

    .sidebar-header {
        display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px;
    }

    .brand {
        font-size: 15px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase;
        color: var(--text-main); display: flex; align-items: center; gap: 12px;
    }
    .brand-dot { 
        width: 8px; height: 8px; background: var(--text-main); border-radius: 50%;
        box-shadow: 0 0 12px rgba(255,255,255,0.6);
    }

    .close-menu-btn { display: none; background: transparent; border: none; color: #fff; padding: 8px; }

    .btn-new {
        width: 100%; padding: 14px;
        background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        color: var(--text-main); font-weight: 600; font-size: 13px;
        cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px;
        transition: all 0.2s var(--ease); margin-bottom: 32px;
    }
    .btn-new:hover { background: rgba(255,255,255,0.08); transform: translateY(-1px); }
    .btn-new:active { transform: scale(0.98); }

    .nav-label { font-size: 11px; color: var(--text-muted); font-weight: 700; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.5; padding-left: 12px; }
    
    .nav-item {
        padding: 12px; border-radius: var(--radius-md); color: #888;
        cursor: pointer; margin-bottom: 4px; font-weight: 500; transition: all 0.2s; font-size: 13px;
    }
    .nav-item:hover { background: var(--glass-highlight); color: #ccc; }
    .nav-item.active { background: rgba(255,255,255,0.08); color: #fff; font-weight: 600; }

    .profile-dock {
        margin-top: auto; padding: 10px;
        background: rgba(0,0,0,0.3); border-radius: var(--radius-md);
        display: flex; align-items: center; gap: 12px;
        cursor: pointer; border: 1px solid rgba(255,255,255,0.05);
        transition: background 0.2s;
    }
    .profile-dock:hover { background: rgba(255,255,255,0.05); }
    .profile-avatar {
        width: 36px; height: 36px; background: #222;
        color: #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center;
        font-weight: 600; border: 1px solid var(--glass-border); font-size: 13px;
    }

    /* --- MAIN LAYOUT --- */
    #main {
        flex: 1;
        background: var(--glass-panel);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-lg);
        display: flex; flex-direction: column;
        position: relative; overflow: hidden;
        box-shadow: 0 0 80px rgba(0,0,0,0.5); /* Deep shadow */
    }

    .mobile-header {
        position: absolute; top: 0; left: 0; width: 100%;
        padding: max(24px, var(--safe-top)) 24px 10px;
        display: flex; justify-content: space-between; align-items: flex-start;
        z-index: 10; pointer-events: none;
    }

    .menu-trigger {
        width: 44px; height: 44px;
        background: rgba(0,0,0,0.4); border: 1px solid var(--glass-border);
        border-radius: 14px; display: none; align-items: center; justify-content: center;
        color: #ddd; cursor: pointer; pointer-events: auto;
        backdrop-filter: blur(10px);
    }

    .tz-btn {
        background: rgba(0,0,0,0.3); border: 1px solid var(--glass-border);
        color: var(--text-muted); padding: 8px 16px; border-radius: 100px;
        font-size: 12px; font-weight: 600; cursor: pointer; pointer-events: auto;
        backdrop-filter: blur(10px); margin-left: auto; transition: 0.2s;
    }
    .tz-btn:hover { color: #fff; background: rgba(255,255,255,0.1); }

    /* --- CHAT AREA --- */
    #chatContainer {
        flex: 1; overflow-y: auto;
        padding: 100px 24px 180px;
        display: flex; flex-direction: column; align-items: center;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
    }
    
    #welcome {
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        height: 100%; width: 100%; transition: opacity 0.4s; text-align: center;
        padding: 0 20px;
    }
    .welcome-title { 
        font-size: 42px; font-weight: 700; margin-bottom: 16px; 
        background: linear-gradient(180deg, #fff, #777); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        letter-spacing: -0.04em;
    }
    .welcome-sub { font-size: 15px; color: var(--text-muted); line-height: 1.6; max-width: 300px; }

    .msg-group {
        width: 100%; max-width: 680px; padding: 4px 0;
        display: flex; gap: 16px;
        animation: slideUp 0.4s var(--ease); margin-bottom: 24px;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    .avatar { 
        width: 32px; height: 32px; flex-shrink: 0; border-radius: 10px; 
        display: flex; align-items: center; justify-content: center; font-size: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    .avatar.ai { background: #fff; color: #000; font-weight: 800; }
    .avatar.user { display: none; }

    .msg-text { 
        flex: 1; font-size: 15px; line-height: 1.6; color: #e0e0e0; white-space: pre-wrap; 
        background: rgba(255,255,255,0.03); padding: 16px 20px;
        border-radius: 4px 20px 20px 20px;
        border: 1px solid transparent;
    }
    
    .avatar.user + .msg-text {
        background: #fff; color: #000;
        border-radius: 20px 20px 4px 20px;
        margin-left: auto; flex: initial; max-width: 80%;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        font-weight: 500;
    }

    /* --- CONFIRMATION CARD (Professional) --- */
    .confirm-card {
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02)); 
        border: 1px solid var(--glass-border);
        border-radius: 16px;
        padding: 20px;
        margin-top: 12px;
        font-size: 14px;
        display: flex; flex-direction: column; gap: 16px;
    }
    .card-header { 
        font-weight: 700; color: #fff; font-size: 12px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.6; 
        margin-bottom: 4px;
    }
    .card-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.06); padding-bottom: 10px; align-items: center; }
    .card-row:last-of-type { border-bottom: none; padding-bottom: 0; }
    .card-label { color: #888; font-size: 13px; font-weight: 500; }
    .card-val { color: #eee; font-weight: 500; text-align: right; max-width: 60%; }

    .card-actions { display: flex; gap: 12px; margin-top: 8px; }
    .btn-action { 
        flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 600; cursor: pointer; font-size: 13px;
        transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .btn-confirm { background: #fff; color: #000; box-shadow: 0 4px 12px rgba(255,255,255,0.2); }
    .btn-confirm:hover { background: #e0e0e0; transform: translateY(-1px); }
    
    .btn-edit { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.05); }
    .btn-edit:hover { background: rgba(255,255,255,0.15); }

    /* --- TYPING INDICATOR --- */
    .typing-indicator {
        display: flex; gap: 5px; padding: 16px 20px; 
        background: rgba(255,255,255,0.03); border-radius: 4px 20px 20px 20px;
        width: fit-content; align-items: center;
        border: 1px solid rgba(255,255,255,0.02);
    }
    .dot { width: 6px; height: 6px; background: #666; border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
    .dot:nth-child(1) { animation-delay: -0.32s; }
    .dot:nth-child(2) { animation-delay: -0.16s; }
    @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.5; } 40% { transform: scale(1); opacity: 1; } }
    .processing-text { margin-left: 10px; font-size: 13px; color: #777; font-weight: 500; }

    /* --- INPUT AREA --- */
    #inputArea {
        position: absolute; bottom: 0; left: 0; width: 100%;
        display: flex; justify-content: center;
        padding: 0 24px max(24px, var(--safe-bottom));
        pointer-events: none; z-index: 20;
    }

    .input-box {
        pointer-events: auto; width: 100%; max-width: 720px;
        background: var(--glass-mobile);
        backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
        border: 1px solid rgba(255,255,255,0.15); border-radius: 28px;
        padding: 12px 12px 12px 20px;
        display: flex; flex-direction: column;
        box-shadow: 0 20px 60px rgba(0,0,0,0.6);
        transition: transform 0.3s;
    }

    .file-preview {
        padding: 10px 14px; background: #222; border-radius: 12px; margin-bottom: 12px; 
        font-size: 13px; color: #ddd; display: none; width: fit-content; border: 1px solid #333;
    }

    .input-row { display: flex; align-items: flex-end; gap: 12px; }

    textarea {
        flex: 1; background: transparent; border: none;
        color: var(--text-main); font-family: inherit; font-size: 16px;
        resize: none; max-height: 120px; min-height: 24px; padding: 14px 0;
        line-height: 1.5;
    }
    textarea::placeholder { color: #555; }

    .icon-btn {
        width: 44px; height: 44px; display: flex; align-items: center; justify-content: center;
        background: transparent; color: #888; border-radius: 50%; cursor: pointer;
        transition: 0.2s;
    }
    .icon-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }

    .send-btn {
        width: 48px; height: 48px; background: var(--text-main); color: #000;
        border: none; border-radius: 20px; display: flex; align-items: center; justify-content: center;
        transition: all 0.2s var(--ease); cursor: pointer;
    }
    .send-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
    .send-btn:active { transform: scale(0.95); }
    .send-btn:disabled { background: #222; color: #444; cursor: default; transform: none; box-shadow: none; }

    /* --- OVERLAYS --- */
    .overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
        z-index: 40; display: none; opacity: 0; transition: opacity 0.3s;
    }
    .overlay.active { display: block; opacity: 1; }

    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); backdrop-filter: blur(15px);
        z-index: 100; display: none; align-items: center; justify-content: center;
        opacity: 0; transition: opacity 0.3s; padding: 20px;
    }
    .modal {
        background: #111; border: 1px solid #333;
        width: 100%; max-width: 360px; padding: 24px; border-radius: 24px;
        transform: scale(0.95); transition: transform 0.3s var(--ease);
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    @media (max-width: 768px) {
        body { padding: 0; gap: 0; }
        
        #sidebar {
            position: fixed; top: 0; left: 0; height: 100%; width: 85%; max-width: 320px;
            border-radius: 0; border: none; border-right: 1px solid #222;
            transform: translateX(-100%);
            padding-top: max(20px, var(--safe-top));
        }
        #sidebar.active { transform: translateX(0); }
        .close-menu-btn { display: block; }
        .menu-trigger { display: flex; }
        #main { border-radius: 0; border: none; background: var(--bg-deep); }
        .input-box { width: 100%; border-radius: 24px; }
        .msg-text { padding: 14px 18px; font-size: 15px; }
        .welcome-title { font-size: 32px; }
    }
</style>
</head>
<body>

<div class="overlay" id="sidebarOverlay"></div>

<div id="sidebar">
    <div class="sidebar-header">
        <div class="brand"><div class="brand-dot"></div> KAIROS</div>
        <button class="close-menu-btn" id="closeMenuBtn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
    </div>
    
    <button class="btn-new" id="newChatBtn">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
        New Schedule
    </button>

    <div class="nav-label">History</div>
    <div class="nav-item" onclick="loadHistory('Project Alpha Sync')">Project Alpha Sync</div>
    <div class="nav-item" onclick="loadHistory('Lagos Team Weekly')">Lagos Team Weekly</div>
    <div class="nav-item" onclick="loadHistory('Client Call (UK)')">Client Call (UK)</div>
    
    <div class="profile-dock" id="profileBtn">
        <div class="profile-avatar">B</div>
        <div style="flex:1">
            <div style="font-size:14px; font-weight:600; color:#fff;">Benedict</div>
            <div style="font-size:12px; color:#888;">Pro Member</div>
        </div>
    </div>
</div>

<div id="main">
    <div class="mobile-header">
        <div class="menu-trigger" id="menuBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </div>
        <button class="tz-btn" id="tzBtn">Africa/Lagos</button>
    </div>

    <div id="chatContainer">
        <div id="welcome">
            <div class="welcome-title">KAIROS</div>
            <div class="welcome-sub">Synchronize your timeline. Drag & drop a schedule or type below.</div>
        </div>
    </div>

    <div id="inputArea">
        <div class="input-box">
            <div class="file-preview" id="filePreview">
                <span id="fileName">image.png</span>
                <span style="margin-left:12px; cursor:pointer; color:#888;" onclick="clearFile()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </span>
            </div>
            
            <div class="input-row">
                <label class="icon-btn" for="fileInput">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                </label>
                <input type="file" id="fileInput" accept="image/*" style="display:none">
                
                <textarea id="msgInput" rows="1" placeholder="Type a message..."></textarea>
                
                <button class="send-btn" id="sendBtn" disabled>
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="tzModal">
    <div class="modal">
        <h3 style="font-size:18px; font-weight:600; margin-bottom:8px; color:#fff;">Timezone</h3>
        <p style="color:#888; font-size:13px; margin-bottom:20px">Select your primary timezone for parsing.</p>
        <div style="display:flex; flex-direction:column; gap:4px">
            <div onclick="setTz('Africa/Lagos', 'Africa/Lagos')" style="padding:14px; border-radius:12px; cursor:pointer; color:#aaa; transition:0.2s; font-weight:500;" onmouseover="this.style.background='#1a1a1a';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#aaa'">Africa/Lagos (WAT)</div>
            <div onclick="setTz('Europe/London', 'Europe/London')" style="padding:14px; border-radius:12px; cursor:pointer; color:#aaa; transition:0.2s; font-weight:500;" onmouseover="this.style.background='#1a1a1a';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#aaa'">Europe/London (GMT)</div>
            <div onclick="setTz('America/New_York', 'America/New_York')" style="padding:14px; border-radius:12px; cursor:pointer; color:#aaa; transition:0.2s; font-weight:500;" onmouseover="this.style.background='#1a1a1a';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='#aaa'">America/New York (EST)</div>
        </div>
        <button onclick="hideModal(document.getElementById('tzModal'))" style="margin-top:20px; width:100%; padding:14px; background:#222; color:#fff; border:none; border-radius:14px; font-weight:600; cursor:pointer; transition:0.2s" onmouseover="this.style.background='#333'">Cancel</button>
    </div>
</div>

<script>
    // --- STATE MANAGEMENT ---
    let currentUserTz = "Africa/Lagos"; 
    
    const els = {
        sidebar: document.getElementById('sidebar'),
        overlay: document.getElementById('sidebarOverlay'),
        chat: document.getElementById('chatContainer'),
        input: document.getElementById('msgInput'),
        send: document.getElementById('sendBtn'),
        fileIn: document.getElementById('fileInput'),
        filePrev: document.getElementById('filePreview'),
        fileName: document.getElementById('fileName'),
        tzBtn: document.getElementById('tzBtn'),
        tzModal: document.getElementById('tzModal'),
        newChatBtn: document.getElementById('newChatBtn')
    };

    // --- SIDEBAR & MODAL LOGIC ---
    function toggleSidebar(show) {
        if (show) { els.sidebar.classList.add('active'); els.overlay.classList.add('active'); } 
        else { els.sidebar.classList.remove('active'); els.overlay.classList.remove('active'); }
    }
    document.getElementById('menuBtn').onclick = () => toggleSidebar(true);
    document.getElementById('closeMenuBtn').onclick = () => toggleSidebar(false);
    els.overlay.onclick = () => toggleSidebar(false);

    els.tzBtn.onclick = () => showModal(els.tzModal);
    window.setTz = (val, label) => {
        currentUserTz = val;
        els.tzBtn.innerText = label;
        hideModal(els.tzModal);
    };

    function showModal(m) { m.style.display = 'flex'; setTimeout(() => { m.style.opacity = '1'; m.firstElementChild.style.transform = 'scale(1)'; }, 10); }
    window.hideModal = (m) => { m.style.opacity = '0'; m.firstElementChild.style.transform = 'scale(0.95)'; setTimeout(() => m.style.display = 'none', 300); };

    // --- INPUT HANDLING ---
    els.input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        checkSend();
    });

    let currentFile = null;
    els.fileIn.addEventListener('change', function(e) {
        if (e.target.files.length) {
            currentFile = e.target.files[0];
            els.fileName.innerText = currentFile.name.length > 20 ? currentFile.name.substring(0,18)+'...' : currentFile.name;
            els.filePrev.style.display = 'flex';
            els.filePrev.style.alignItems = 'center';
            checkSend();
        }
    });
    window.clearFile = () => { currentFile = null; els.fileIn.value = ''; els.filePrev.style.display = 'none'; checkSend(); };
    function checkSend() { els.send.disabled = !(els.input.value.trim().length > 0 || currentFile); }

    // --- NEW CHAT LOGIC ---
    els.newChatBtn.onclick = () => {
        toggleSidebar(false);
        els.chat.innerHTML = `
            <div id="welcome">
                <div class="welcome-title">KAIROS</div>
                <div class="welcome-sub">Synchronize your timeline. Drag & drop a schedule or type below.</div>
            </div>`;
        els.input.value = '';
        clearFile();
    };

    // --- HISTORY SIMULATION ---
    window.loadHistory = (title) => {
        toggleSidebar(false);
        els.chat.innerHTML = ''; // Clear chat
        
        // Simulate previous conversation
        addMsg(`Sync details for ${title}`, 'user');
        
        const timestamp = new Date().toLocaleDateString();
        
        const responseHTML = `
            <div>History retrieved for <strong>${title}</strong>:</div>
            <div class="confirm-card" style="opacity:0.8; margin-top:20px;">
                <div class="card-header">Confirmed Event</div>
                <div class="card-row"><span class="card-label">Event</span><span class="card-val">${title}</span></div>
                <div class="card-row"><span class="card-label">Date</span><span class="card-val">${timestamp}</span></div>
                <div class="card-row"><span class="card-label">Status</span><span class="card-val" style="color:#4caf50">Scheduled</span></div>
            </div>
        `;
        
        // Add artificial delay for realism
        setTimeout(() => addMsgHTML(responseHTML, 'ai'), 300);
    };

    // --- SEND LOGIC & INTEGRATION ---
    els.send.onclick = send;

    async function send() {
        if (els.send.disabled) return;
        const rawText = els.input.value;
        const isFile = !!currentFile;
        const fileName = currentFile ? currentFile.name : null;

        // UI Updates
        const welcome = document.getElementById('welcome');
        if (welcome) welcome.style.display = 'none';
        
        let displayMsg = rawText;
        if(isFile && !rawText) displayMsg = `[Attached: ${fileName}]`;
        if(isFile && rawText) displayMsg = `${rawText}\n\n[Attached: ${fileName}]`;

        addMsg(displayMsg, 'user');
        
        // Clear Inputs
        els.input.value = ''; els.input.style.height = 'auto'; clearFile();

        // 1. Show Loading Indicator
        const loadingId = addLoadingIndicator(isFile ? "Analyzing screenshot..." : "Syncing with Kairos...");

        // 2. Prepare Payload
        // We use current date/time to help the AI understand relative terms like "tomorrow"
        const now = new Date();
        const payload = {
            message: rawText,
            timezone: currentUserTz,
            date: now.toISOString().split('T')[0], // YYYY-MM-DD
            time: now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) // HH:MM (24h)
        };

        // 3. API Call to Webhook
        try {
            const response = await fetch('https://ciroma.app.n8n.cloud/webhook/058f5cca-0b25-4ef1-ae1a-6ce8b48d6450/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            console.log("Webhook Response:", data);

            // 4. Handle Response
            removeLoadingIndicator(loadingId);
            handleRealResponse(data);

        } catch (err) {
            console.error('Error connecting to webhook:', err);
            removeLoadingIndicator(loadingId);
            addMsg("I'm having trouble connecting to the Kairos server. Please try again.", 'ai');
        }
    }

    // --- API RESPONSE HANDLER ---
    function handleRealResponse(data) {
        // Fallback message if the server doesn't provide one
        let mainMessage = data.message || "I've processed your request.";

        if (data.needsClarification) {
            // If the bot needs more info, just show the text
            addMsg(mainMessage, 'ai');
        } else if (data.success) {
            // If successful, show message AND a confirmation card
            // We check if the data object contains event details, otherwise we use generic placeholders
            const eventName = data.event_title || data.summary || "New Event";
            const eventDate = data.event_date || "Unknown Date";
            const eventTime = data.event_time || "All Day";

            const responseHTML = `
                <div>${mainMessage}</div>
                <div class="confirm-card" id="card-${Date.now()}">
                    <div class="card-header">Proposed Schedule</div>
                    <div class="card-row"><span class="card-label">Event</span><span class="card-val">${eventName}</span></div>
                    <div class="card-row"><span class="card-label">Date</span><span class="card-val">${eventDate}</span></div>
                    <div class="card-row"><span class="card-label">Time</span><span class="card-val">${eventTime}</span></div>
                    
                    <div class="card-actions">
                        <button class="btn-action btn-confirm" onclick="triggerConfirm(this)">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            Confirm
                        </button>
                        <button class="btn-action btn-edit" onclick="triggerEdit(this)">Edit</button>
                    </div>
                </div>
            `;
            addMsgHTML(responseHTML, 'ai');
        } else {
            // Generic catch-all
            addMsg(mainMessage, 'ai');
        }
    }

    // --- INTERACTIVE BUTTON FUNCTIONS ---
    window.triggerConfirm = (btn) => {
        // Visual feedback
        const card = btn.closest('.confirm-card');
        const actions = card.querySelector('.card-actions');
        
        actions.innerHTML = `
            <div style="width:100%; padding:12px; background:rgba(76, 175, 80, 0.1); color:#4caf50; border:1px solid rgba(76, 175, 80, 0.3); border-radius:12px; text-align:center; font-weight:600; display:flex; align-items:center; justify-content:center; gap:8px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>
                Scheduled Successfully
            </div>
        `;
        
        setTimeout(() => {
            addMsg("I've sent the invites to your calendar.", 'ai');
        }, 800);
    };

    window.triggerEdit = (btn) => {
        const card = btn.closest('.confirm-card');
        // Dim the card to show it's being edited
        card.style.opacity = '0.5';
        card.style.pointerEvents = 'none';
        
        addMsg("What detail would you like to update?", 'ai');
        els.input.focus();
    };

    // --- UI HELPERS ---
    function addMsg(txt, role) {
        const grp = document.createElement('div');
        grp.className = 'msg-group';
        const ava = document.createElement('div');
        ava.className = `avatar ${role}`;
        if(role === 'ai') ava.innerText = 'K';
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-text';
        bubble.innerText = txt;

        grp.appendChild(ava);
        grp.appendChild(bubble);
        els.chat.appendChild(grp);
        scrollToBottom();
    }

    function addMsgHTML(html, role) {
        const grp = document.createElement('div');
        grp.className = 'msg-group';
        const ava = document.createElement('div');
        ava.className = `avatar ${role}`;
        if(role === 'ai') ava.innerText = 'K';
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-text';
        bubble.innerHTML = html;

        grp.appendChild(ava);
        grp.appendChild(bubble);
        els.chat.appendChild(grp);
        scrollToBottom();
    }

    function addLoadingIndicator(text) {
        const id = 'loading-' + Date.now();
        const grp = document.createElement('div');
        grp.className = 'msg-group';
        grp.id = id;
        
        const ava = document.createElement('div');
        ava.className = `avatar ai`;
        ava.innerText = 'K';
        
        const bubble = document.createElement('div');
        bubble.className = 'msg-text';
        bubble.style.display = 'flex';
        bubble.style.alignItems = 'center';
        
        bubble.innerHTML = `
            <div class="typing-indicator">
                <div class="dot"></div><div class="dot"></div><div class="dot"></div>
            </div>
            <span class="processing-text">${text}</span>
        `;

        grp.appendChild(ava);
        grp.appendChild(bubble);
        els.chat.appendChild(grp);
        scrollToBottom();
        return id;
    }

    function removeLoadingIndicator(id) {
        const el = document.getElementById(id);
        if(el) {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 200);
        }
    }

    function scrollToBottom() {
        els.chat.scrollTo({ top: els.chat.scrollHeight, behavior: 'smooth' });
    }
</script>
</body>
</html>
