<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <script src="js/auth-guard.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KAIROS | Team Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/chat.css">
    <script src="js/components.js"></script>
    <script>
        const savedTheme = localStorage.getItem('kairosTheme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);

        document.addEventListener('DOMContentLoaded', () => {
            renderSidebar('teamchat');
            // Init Chat Logic Here (or include dash JS if it has chat logic)
        });

        // Simple Toggle for Demo
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('kairosTheme', newTheme);
            updateLogoTheme();
        }
    </script>
</head>

<body>


    <div id="toast"><i class="ph-bold ph-check-circle"></i> <span id="toastMsg">Action Complete</span></div>

    <div id="sidebar-container"></div>

    <main id="main">
        <div id="view-teamchat" class="view-section active" style="display:flex; flex-direction:row; height:100%;">

            <!-- LEFT SIDEBAR (Chat List) -->
            <div class="chat-sidebar"
                style="width:320px; border-right:1px solid var(--border); display:flex; flex-direction:column;">
                <div class="chat-header">
                    <div class="view-title">Team Chat</div>
                    <div class="header-actions">
                        <i class="ph-bold ph-note-pencil"></i>
                        <i class="ph-bold ph-dots-three"></i>
                    </div>
                </div>

                <div class="search-container">
                    <div class="search-bar">
                        <i class="ph-bold ph-magnifying-glass"></i>
                        <input type="text" placeholder="Search teams...">
                    </div>
                </div>

                <div class="filter-chips">
                    <div class="chat-chip active">All</div>
                    <div class="chat-chip">Unread</div>
                    <div class="chat-chip">Groups</div>
                </div>

                <div class="chat-list" id="chatList">
                    <!-- Chat Items Injected Here -->
                </div>
            </div>

            <!-- RIGHT MAIN CHAT -->
            <div class="chat-main" id="chatMain">
                <div class="chat-header chat-header-main">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <button class="theme-toggle" onclick="closeChat()" id="backBtn" style="display:none;"><i
                                class="ph-bold ph-arrow-left"></i></button>
                        <div class="avatar-large" id="currentChatAvatar">
                            <span id="currAvatarText"
                                style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#fff; font-size:20px;"></span>
                        </div>
                        <div>
                            <div class="chat-name" id="currentChatName">Select a Team</div>
                            <div class="chat-time" id="currentChatStatus"></div>
                        </div>
                    </div>
                    <div class="header-actions">
                        <i class="ph-bold ph-video-camera"
                            onclick="window.location.href='gemini-meeting-room.html'"></i>
                        <i class="ph-bold ph-phone" onclick="window.location.href='gemini-meeting-room.html'"></i>
                        <i class="ph-bold ph-magnifying-glass"></i>
                        <div style="border-left:1px solid var(--border); padding-left:16px;">
                            <i class="ph-bold ph-sidebar"></i>
                        </div>
                    </div>
                </div>

                <div class="chat-messages" id="msgsArea">
                    <div
                        style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--text-secondary); text-align:center;">
                        <i class="ph-duotone ph-chats-circle"
                            style="font-size:64px; margin-bottom:16px; opacity:0.5;"></i>
                        <h3 style="color:var(--text-primary); font-weight:300; margin-bottom:8px;">KAIROS <span
                                style="font-weight:600">Team Sync</span></h3>
                        <p style="font-size:14px;">Select a team to start collaborating.<br>Real-time updates enabled.
                        </p>
                    </div>
                </div>

                <div class="chat-footer" id="chatFooter" style="display:none;">
                    <i class="ph-bold ph-smiley footer-icon"></i>
                    <i class="ph-bold ph-paperclip footer-icon"></i>
                    <div class="chat-input-box">
                        <input type="text" placeholder="Type a message..." id="msgInput"
                            onkeypress="handleEnter(event)">
                    </div>
                    <i class="ph-bold ph-microphone footer-icon"></i>
                    <div class="send-btn" onclick="sendMessage()">
                        <i class="ph-bold ph-paper-plane-right"></i>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/dashboard.js"></script>
    <script>
        // --- CHAT LOGIC ---
        // Groups only, real-time simulation

        const CHAT_DATA = [
            { id: 1, name: "Engineering", members: "Benedict, Sarah, Mike", time: "10:42", msg: "Deployment scheduled for Friday.", unread: 2, active: true },
            { id: 2, name: "Product Design", members: "Alice, Bob, Carol", time: "09:15", msg: "New mockups are in the drive.", unread: 0, active: false },
            { id: 3, name: "Marketing Alpha", members: "Dave, Eve", time: "Yesterday", msg: "Campaign launch readiness?", unread: 5, active: false },
            { id: 4, name: "Leadership", members: "Execs only", time: "Mon", msg: "Q1 Strategy Deck review.", unread: 0, active: false },
            { id: 5, name: "Watercooler", members: "Everyone", time: "Fri", msg: "Lunch at 12?", unread: 0, active: false }
        ];

        let currentChatId = null;

        document.addEventListener('DOMContentLoaded', () => {
            renderChatList();

            // Random incoming message simulation
            setInterval(simulateIncomingMessage, 8000 + Math.random() * 5000);
        });

        function renderChatList() {
            const list = document.getElementById('chatList');
            list.innerHTML = '';

            CHAT_DATA.forEach(c => {
                const el = document.createElement('div');
                el.className = `chat-item ${currentChatId === c.id ? 'active' : ''}`;
                el.onclick = () => loadChat(c.id);

                // Group Avatar (Initials)
                let initials = c.name.substring(0, 2).toUpperCase();
                let avatarHtml = `<div class="avatar-large" style="background:var(--surface-hover); border:1px solid var(--border);">
                    <span style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size:16px; color:var(--text-primary); font-weight:700;">${initials}</span>
                </div>`;

                // Wrapper for unread
                let badge = c.unread > 0 ? `<div class="unread-badge">${c.unread}</div>` : '';

                el.innerHTML = `
                    ${avatarHtml}
                    <div class="chat-info">
                        <div class="chat-top">
                            <span class="chat-name">${c.name}</span>
                            <span class="chat-time">${c.time}</span>
                        </div>
                        <div class="chat-bottom">
                            <div class="chat-preview" id="preview-${c.id}">
                                <span style="color:var(--text-secondary);">${c.msg}</span>
                            </div>
                            ${badge}
                        </div>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        function loadChat(id) {
            currentChatId = id;
            const c = CHAT_DATA.find(x => x.id === id);
            if (!c) return;

            // Update UI state
            renderChatList();

            // Mobile handling
            if (window.innerWidth <= 900) {
                document.getElementById('chatMain').classList.add('active');
                document.getElementById('backBtn').style.display = 'block';
            }

            // Set Header
            document.getElementById('currentChatName').innerText = c.name;
            document.getElementById('currentChatStatus').innerText = c.members;
            document.getElementById('chatFooter').style.display = 'flex';

            // Set Avatar
            const avTxt = document.getElementById('currAvatarText');
            const avCon = document.getElementById('currentChatAvatar');

            avTxt.innerText = c.name.substring(0, 2).toUpperCase();
            avCon.style.background = 'var(--text-primary)';
            avCon.style.color = 'var(--bg-main)';

            // Render Messages
            const area = document.getElementById('msgsArea');
            area.innerHTML = '';

            // Add Date Separator
            area.innerHTML += `<div class="msg-date-separator">Today</div>`;

            // Add dummy history
            addMessageToView('incoming', "Hey team, just checking in on progress.");
            addMessageToView('outgoing', "All good here, moving to next phase.");
            addMessageToView('incoming', c.msg); // Last message

            // Scroll to bottom
            area.scrollTop = area.scrollHeight;
        }

        function addMessageToView(type, text) {
            const area = document.getElementById('msgsArea');
            const msg = document.createElement('div');
            msg.className = `message ${type}`;

            // Random sender name for groups
            let sender = type === 'incoming' ? '<div style="font-size:10px; font-weight:700; color:var(--accent); margin-bottom:2px;">Member</div>' : '';

            msg.innerHTML = `
                ${sender}
                ${text}
                <div class="msg-info">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</div>
            `;
            area.appendChild(msg);
            area.scrollTop = area.scrollHeight;
        }

        function handleEnter(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('msgInput');
            const txt = input.value;
            if (!txt) return;

            addMessageToView('outgoing', txt);

            // Update data model for preview
            if (currentChatId) {
                const c = CHAT_DATA.find(x => x.id === currentChatId);
                c.msg = "You: " + txt;
                c.time = "Now";
                renderChatList();
            }

            input.value = '';
        }

        function closeChat() {
            document.getElementById('chatMain').classList.remove('active');
            currentChatId = null;
            renderChatList();
        }

        // --- SIMULATION LOGIC ---
        function simulateIncomingMessage() {
            // Pick a random chat other than current one (sometimes current one)
            const randomChatIndex = Math.floor(Math.random() * CHAT_DATA.length);
            const chat = CHAT_DATA[randomChatIndex];

            const strategies = [
                "Can someone review the PR?",
                "Meeting starting in 5 mins.",
                "Updated the documentation.",
                "Great work everyone!",
                "Does anyone have the latest assets?"
            ];
            const randomMsg = strategies[Math.floor(Math.random() * strategies.length)];

            // Update Model
            chat.msg = randomMsg;
            chat.time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            if (currentChatId === chat.id) {
                // If open, just append
                addMessageToView('incoming', randomMsg);
            } else {
                // If not open, increment unread
                chat.unread += 1;
                showToast(`New message in ${chat.name}`);
            }
            renderChatList();
        }

    </script>
</body>

</html>